
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IEG CRM</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Libraries (Global Access via CDN) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    
    <!-- Lucide Icons (React Version) -->
    <script src="https://unpkg.com/lucide-react/dist/umd/lucide-react.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google GenAI SDK Import Map -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@0.1.0",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "recharts": "https://aistudiocdn.com/recharts@^3.4.1",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* Animation Classes */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        .animate-slide-in { animation: fadeIn 0.3s ease-out; }
        
        /* Print Styles for PDF Export */
        @media print {
          body * { visibility: hidden; }
          .dashboard-container, .dashboard-container * { visibility: visible; }
          .dashboard-container { 
            position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px; background: white; 
          }
          aside, header, .no-print, button, .recharts-tooltip-wrapper { display: none !important; }
          .shadow-sm, .shadow-lg { box-shadow: none !important; border: 1px solid #ddd; }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Recharts Override */
        .recharts-wrapper { width: 100% !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenAI } from "@google/genai";

        // ==========================================
        // 1. GLOBAL SETUP & CONSTANTS
        // ==========================================
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, PieChart, Pie } = Recharts;
        
        // Destructure Icons
        const { 
            LayoutDashboard, Users, Kanban, Menu, X, Sparkles, Mail, Save, RefreshCw, 
            Settings: SettingsIcon, FileSpreadsheet, ChevronUp, ChevronDown, Check, 
            Activity, Search, Plus, Trash2, MapPin, Edit, ArrowLeft, Phone, Building, 
            Edit3, Send, Target, Calendar, Briefcase, TrendingUp, Printer, Download, 
            UploadCloud, Camera, User, AlertCircle 
        } = window.lucideReact; // Access Lucide from global window object

        const API_KEY = 'AIzaSyA6fwFuyNGy3Kh6hojdsVZD640tK_QlJNw'; 
        const STORAGE_KEY = 'ieg_crm_data_v17'; 

        // Enums & Types Simulation
        const DealStage = {
            LEAD: '가망 고객 (Lead)',
            QUALIFIED: '적격 단계 (Qualified)',
            PROPOSAL: '제안 단계 (Proposal)',
            NEGOTIATION: '협상 단계 (Negotiation)',
            CLOSED_WON: '계약 성사 (Closed Won)',
            CLOSED_LOST: '계약 실패 (Closed Lost)'
        };

        const MOCK_SALES_REPS = [
          { id: 's1', name: '홍길동', team: '영업 1팀', department: '영업본부', role: 'manager', email: 'hong@ieg.com', phone: '010-1234-5678' },
          { id: 's2', name: '김영업', team: '영업 2팀', department: '영업본부', role: 'staff', email: 'kim@ieg.com', phone: '010-2345-6789' },
          { id: 's3', name: '이수진', team: '영업 1팀', department: '영업본부', role: 'staff', email: 'lee@ieg.com', phone: '010-3456-7890' },
          { id: 's4', name: '박이사', team: '임원실', department: '영업본부', role: 'director', email: 'park@ieg.com', phone: '010-4567-8901' },
          { id: 's5', name: '최성실', team: '영업 2팀', department: '영업본부', role: 'staff', email: 'choi@ieg.com', phone: '010-5678-9012' },
        ];

        const now = new Date();
        const currentYear = now.getFullYear();
        const getDateInYear = (month, day) => new Date(currentYear, month, day).toISOString().split('T')[0];

        const GRADES = ['S', 'A', 'B', 'C', 'D'];
        const LOCATIONS = ['서울 강남구', '서울 종로구', '경기 성남시', '대전 유성구', '부산 해운대구', '인천 송도', '충북 청주시', '세종시', '광주 북구'];
        const BASE_COMPANIES = [
            '태크코프', '이노베이트', '미래산업', '한국대학교', '서울과학기술대', 'KAIST', 'ETRI', 'KISTI', 
            '소프트웨어산업협회', '정보통신산업진흥원', '삼성전자', 'LG전자', '현대자동차', 'SK하이닉스', 
            '네이버', '카카오', '포스코', '한화시스템', 'LIG넥스원', 'KAI', '서울대', '연세대', '고려대',
            '부산대', '경북대', '전남대', '충남대', '전자통신연구원', '기계연구원', '화학연구원'
        ];

        // --- Data Generators ---
        const generateContacts = () => {
            const contacts = [];
            let globalIdx = 0;
            // Iterate all reps to ensure coverage
            MOCK_SALES_REPS.forEach((rep) => {
                const count = 10 + Math.floor(Math.random() * 5); 
                for (let i = 0; i < count; i++) {
                    const companyName = BASE_COMPANIES[globalIdx % BASE_COMPANIES.length] + (Math.floor(globalIdx / BASE_COMPANIES.length) > 0 ? ` ${Math.floor(globalIdx / BASE_COMPANIES.length) + 1}` : '');
                    const type = companyName.includes('대') ? 'University' : (companyName.includes('연구원') || companyName.includes('진흥원') ? 'Institute' : (companyName.includes('협회') ? 'Association' : 'Company'));
                    
                    contacts.push({
                        id: `c${globalIdx + 1}`,
                        name: `담당자${globalIdx + 1}`,
                        email: `contact${globalIdx + 1}@${type === 'Company' ? 'company.com' : 'org.kr'}`,
                        phone: `010-${1000 + globalIdx}-${2000 + globalIdx}`,
                        company: companyName,
                        type: type,
                        address: LOCATIONS[globalIdx % LOCATIONS.length],
                        role: globalIdx % 3 === 0 ? '팀장' : '책임',
                        department: rep.team,
                        lastContacted: getDateInYear(now.getMonth(), (globalIdx % 28) + 1),
                        notes: [`${currentYear}년 사업 계획 논의 필요`],
                        grade: GRADES[globalIdx % GRADES.length],
                        targetAmount: (Math.floor(Math.random() * 50) + 10) * 10000000,
                        owner: rep.name,
                        team: rep.team
                    });
                    globalIdx++;
                }
            });
            return contacts;
        };

        const MOCK_CONTACTS = generateContacts();

        const generateDeals = () => {
            const deals = [];
            let dealIdCounter = 1;
            MOCK_CONTACTS.forEach(contact => {
                const dealCount = 3 + Math.floor(Math.random() * 4);
                for(let i = 0; i < dealCount; i++) {
                     const month = Math.floor(Math.random() * 12);
                     const day = Math.floor(Math.random() * 28) + 1;
                     const status = ['매출', '확정', '예정', '미정'][Math.floor(Math.random() * 4)];
                     const value = (Math.floor(Math.random() * 20) + 5) * 5000000;
                     const prodRatio = 0.7 + (Math.random() * 0.2);
                     const productAmount = Math.round(value * prodRatio);
                     
                     let stage = '가망 고객 (Lead)';
                     let prob = 20;
                     if(status === '매출') { stage = '계약 성사 (Closed Won)'; prob = 100; }
                     else if(status === '확정') { stage = '협상 단계 (Negotiation)'; prob = 90; }
                     else if(status === '예정') { stage = '제안 단계 (Proposal)'; prob = 60; }

                     deals.push({
                        id: `d${dealIdCounter++}`,
                        title: `${contact.company} ${month+1}월 납품`,
                        value: value,
                        productAmount: productAmount,
                        goodsAmount: value - productAmount,
                        itemDetails: `서버 ${Math.floor(Math.random()*5)+1}대`,
                        status: status,
                        stage: stage,
                        contactId: contact.id,
                        expectedCloseDate: getDateInYear(month, day),
                        probability: prob,
                        owner: contact.owner,
                        team: contact.team,
                        department: '영업본부'
                     });
                }
            });
            return deals;
        };

        const MOCK_DEALS = generateDeals();

        // ==========================================
        // 2. SERVICES
        // ==========================================
        const ai = new GoogleGenAI({ apiKey: API_KEY });
        const isLocal = !window.google || !window.google.script;

        // --- Gemini AI Functions ---
        const generateEmailDraft = async (contactName, company, context) => {
          if (!API_KEY) return "API 키가 필요합니다.";
          try {
            const res = await ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: `작성자: 영업 담당자, 수신자: ${contactName} (${company}), 맥락: ${context}. 정중한 한국어 이메일 초안 작성.`,
            });
            return res.text;
          } catch (e) { return "생성 실패"; }
        };

        const summarizeMeetingNotes = async (rawNotes) => {
             if (!API_KEY) return "API 키가 필요합니다.";
             try {
                 const res = await ai.models.generateContent({
                     model: 'gemini-2.5-flash',
                     contents: `회의 메모 요약 (한국어): "${rawNotes}"`
                 });
                 return res.text;
             } catch(e) { return "요약 실패"; }
        };

        const assessAccountGrade = async (companyName, type, currentValue, notes) => {
            if (!API_KEY) return "API 키가 필요합니다.";
            try {
                const prompt = `
                  기업: ${companyName}, 유형: ${type}, 가치: ${currentValue}, 메모: ${notes}.
                  [지시] Google Search로 최신 현황(재무, 뉴스 등) 조사 후 등급(S/A/B/C/D) 평가.
                  [출력] 등급: [등급], 분석: [요약]
                `;
                const res = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                    config: { tools: [{ googleSearch: {} }] }
                });
                return res.text;
            } catch(e) { return "분석 실패: " + e.message; }
        };

        const generateWeeklyReport = async (deals, contacts) => {
            if (!API_KEY) return "API 키가 필요합니다.";
            try {
                 const summary = deals.slice(0, 10).map(d => `${d.status} - ${d.title}`).join('\n');
                 const prompt = `주간 영업 리포트 (HTML 형식, <h3>,<ul> 사용). 파이프라인: ${summary}`;
                 const res = await ai.models.generateContent({ model: 'gemini-2.5-flash', contents: prompt });
                 return res.text;
            } catch(e) { return "리포트 실패"; }
        };

        const analyzeDealHealth = async (title, stage, value, notes) => {
             if (!API_KEY) return "키 확인 필요";
             try {
                 const res = await ai.models.generateContent({
                     model: 'gemini-2.5-flash',
                     contents: `거래 건전성 분석. ${title}, ${stage}, ${value}. 평가 3줄.`
                 });
                 return res.text;
             } catch(e) { return "분석 실패"; }
        };

        // --- Storage & GAS Functions ---
        const loadInitialData = () => {
          return new Promise((resolve) => {
            if (isLocal) {
               const localData = localStorage.getItem(STORAGE_KEY);
               if (localData) { try { resolve(JSON.parse(localData)); return; } catch(e){} }
               localStorage.setItem(STORAGE_KEY, JSON.stringify({ contacts: MOCK_CONTACTS, deals: MOCK_DEALS, salesReps: MOCK_SALES_REPS }));
               resolve({ contacts: MOCK_CONTACTS, deals: MOCK_DEALS, salesReps: MOCK_SALES_REPS });
               return;
            }
            // Google Apps Script Call
            google.script.run
              .withSuccessHandler((res) => {
                  try {
                      const parsed = JSON.parse(res);
                      if ((!parsed.contacts || parsed.contacts.length === 0)) {
                          resolve({ contacts: MOCK_CONTACTS, deals: MOCK_DEALS, salesReps: MOCK_SALES_REPS });
                      } else {
                          resolve(parsed);
                      }
                  } catch (e) { resolve({ contacts: MOCK_CONTACTS, deals: MOCK_DEALS, salesReps: MOCK_SALES_REPS }); }
              })
              .withFailureHandler(() => resolve({ contacts: MOCK_CONTACTS, deals: MOCK_DEALS, salesReps: MOCK_SALES_REPS }))
              .getCRMData();
          });
        };

        const saveDataToSheet = (contacts, deals, salesReps) => {
            return new Promise((resolve, reject) => {
                if (isLocal) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({ contacts, deals, salesReps }));
                    resolve(); return;
                }
                google.script.run
                    .withSuccessHandler(() => {
                        google.script.run
                            .withSuccessHandler(() => {
                                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).saveCRMData('salesReps', JSON.stringify(salesReps));
                            }).withFailureHandler(reject).saveCRMData('deals', JSON.stringify(deals));
                    }).withFailureHandler(reject).saveCRMData('contacts', JSON.stringify(contacts));
            });
        };

        const sendReportEmail = (email, subject, body) => {
            return new Promise((resolve, reject) => {
                if (isLocal) { console.log("Email Mock Sent"); resolve(); return; }
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).sendEmail(email, subject, body);
            });
        };

        const syncSheetData = () => {
            return loadInitialData();
        };

        const resetToSampleData = () => {
            if(isLocal) localStorage.removeItem(STORAGE_KEY);
            return Promise.resolve();
        };

        // ==========================================
        // 3. COMPONENTS
        // ==========================================

        const WonIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} width="24" height="24">
            <path d="M4 4l4 16" /><path d="M20 4l-4 16" /><path d="M8 20l4-10" /><path d="M16 20l-4-10" /><path d="M2 10h20" opacity="0.5"/><path d="M2 14h20" opacity="0.5"/>
          </svg>
        );

        // --- DASHBOARD ---
        const Dashboard = ({ deals, contacts, currentUser, salesReps, onExportToSheet }) => {
            const [scope, setScope] = useState('individual');
            const [timePeriod, setTimePeriod] = useState('year');
            const [selectedUser, setSelectedUser] = useState(currentUser.name);
            const [selectedTeam, setSelectedTeam] = useState(currentUser.team);
            const [showExportMenu, setShowExportMenu] = useState(false);

            const teams = useMemo(() => Array.from(new Set(salesReps.map(r => r.team).filter(Boolean))).sort(), [salesReps]);

            useEffect(() => {
                if (!selectedUser && currentUser.name) setSelectedUser(currentUser.name);
                if (!selectedTeam && currentUser.team) setSelectedTeam(currentUser.team);
                if (!selectedTeam && teams.length > 0) setSelectedTeam(teams[0]);
            }, [currentUser, teams]);

            const filterByScope = (items) => {
                if (!items) return [];
                return items.filter(item => {
                    if (scope === 'individual') return item.owner === selectedUser;
                    if (scope === 'team') return item.team === selectedTeam;
                    return true;
                });
            };

            const scopedContacts = useMemo(() => filterByScope(contacts), [contacts, scope, selectedUser, selectedTeam]);
            const scopedDeals = useMemo(() => filterByScope(deals), [deals, scope, selectedUser, selectedTeam]);

            const filteredDeals = useMemo(() => {
                return scopedDeals.filter(d => {
                    const date = new Date(d.expectedCloseDate);
                    const n = new Date();
                    if (timePeriod === 'year') return date.getFullYear() === n.getFullYear();
                    if (timePeriod === 'month') return date.getMonth() === n.getMonth() && date.getFullYear() === n.getFullYear();
                    if (timePeriod === 'quarter') return Math.floor(date.getMonth()/3) === Math.floor(n.getMonth()/3) && date.getFullYear() === n.getFullYear();
                    return true;
                });
            }, [scopedDeals, timePeriod]);

            const targetAmount = useMemo(() => {
                const total = scopedContacts.reduce((acc, c) => acc + (c.targetAmount || 0), 0);
                return timePeriod === 'month' ? Math.round(total/12) : (timePeriod === 'quarter' ? Math.round(total/4) : total);
            }, [scopedContacts, timePeriod]);

            const performanceAmount = filteredDeals.filter(d => d.status === '매출' || d.stage.includes('Won')).reduce((acc, d) => acc + d.value, 0);
            const confirmedAmount = filteredDeals.filter(d => d.status === '확정').reduce((acc, d) => acc + d.value, 0);
            const expectedAmount = filteredDeals.filter(d => d.status === '예정').reduce((acc, d) => acc + d.value, 0);
            const undecidedAmount = filteredDeals.filter(d => d.status === '미정').reduce((acc, d) => acc + d.value, 0);

            const monthlyData = useMemo(() => {
                const data = Array.from({length: 12}, (_, i) => ({ name: `${i + 1}월`, 매출: 0, 확정: 0, 예정: 0, 미정: 0 }));
                scopedDeals.forEach(deal => {
                    const date = new Date(deal.expectedCloseDate);
                    if (date.getFullYear() === new Date().getFullYear()) {
                        const m = date.getMonth();
                        if (data[m]) data[m][deal.status] += deal.value;
                    }
                });
                return data;
            }, [scopedDeals]);

            const gradeData = useMemo(() => {
                const sums = {};
                scopedContacts.forEach(c => { const g = c.grade || 'D'; sums[g] = (sums[g] || 0) + (c.targetAmount || 0); });
                return Object.keys(sums).map(k => ({ name: k, value: sums[k] })).sort((a,b) => b.value - a.value);
            }, [scopedContacts]);

            const formatCurrency = (v) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(v);
            const formatMillions = (v) => `₩${Math.round(v / 1000000).toLocaleString()}백만`;
            const STACK_COLORS = { '매출': '#10b981', '확정': '#3b82f6', '예정': '#f59e0b', '미정': '#94a3b8' };
            const GRADE_COLORS = { 'S': '#4f46e5', 'A': '#10b981', 'B': '#f59e0b', 'C': '#f97316', 'D': '#ef4444' };

            return (
                <div className="space-y-6 animate-fade-in pb-10 dashboard-container">
                    <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 no-print">
                         <div className="flex items-center gap-3">
                            <h2 className="text-2xl font-bold text-slate-800">영업 대시보드</h2>
                            <div className="flex items-center bg-white rounded-md border p-0.5">
                                {['month','quarter','year'].map(p => (
                                    <button key={p} onClick={()=>setTimePeriod(p)} className={`px-3 py-1.5 text-xs font-medium rounded-sm ${timePeriod===p?'bg-slate-800 text-white':'text-slate-600'}`}>{p==='month'?'월별':p==='quarter'?'분기별':'누계'}</button>
                                ))}
                            </div>
                         </div>
                         <div className="flex flex-wrap items-center gap-3">
                            <div className="relative inline-flex bg-white rounded-lg border p-1">
                                {['individual','team','all'].map(s => (
                                    <button key={s} onClick={()=>setScope(s)} className={`px-3 py-1.5 text-sm font-medium rounded-md ${scope===s?'bg-indigo-100 text-indigo-700':'text-slate-600'}`}>{s==='individual'?'개인별':s==='team'?'팀별':'전체'}</button>
                                ))}
                            </div>
                            {scope==='individual' && <select value={selectedUser} onChange={e=>setSelectedUser(e.target.value)} className="pl-3 pr-8 py-2 bg-white border rounded-lg text-sm">{salesReps.map(r=><option key={r.id} value={r.name}>{r.name}</option>)}</select>}
                            {scope==='team' && <select value={selectedTeam} onChange={e=>setSelectedTeam(e.target.value)} className="pl-3 pr-8 py-2 bg-white border rounded-lg text-sm">{teams.map(t=><option key={t} value={t}>{t}</option>)}</select>}
                            <div className="relative">
                                <button onClick={()=>setShowExportMenu(!showExportMenu)} className="flex items-center px-3 py-2 bg-white border rounded-lg text-sm"><Download size={16} className="mr-2"/> 내보내기</button>
                                {showExportMenu && (
                                    <div className="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border z-20 py-1" onClick={()=>setShowExportMenu(false)}>
                                        <button onClick={onExportToSheet} className="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 flex items-center"><FileSpreadsheet size={16} className="mr-2 text-emerald-600"/> Google Sheet</button>
                                        <button onClick={()=>window.print()} className="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 flex items-center"><Printer size={16} className="mr-2 text-slate-500"/> PDF (인쇄)</button>
                                    </div>
                                )}
                            </div>
                         </div>
                    </div>
                    
                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <div className="md:col-span-2 lg:col-span-5 bg-white p-4 rounded-xl shadow-sm border flex flex-col md:flex-row justify-between items-center relative overflow-hidden min-h-[105px]">
                            <div className="z-10">
                                <p className="text-sm font-bold text-slate-500 flex items-center gap-2">
                                    총 목표 금액
                                    <span className="inline-flex items-center px-2 py-0.5 bg-indigo-50 text-indigo-700 text-[10px] rounded-full font-bold border border-indigo-100">{scope==='individual'?selectedUser:scope==='team'?selectedTeam:'전체'}</span>
                                </p>
                                <p className="text-3xl font-extrabold text-slate-900">{formatCurrency(targetAmount)}</p>
                            </div>
                            <div className="text-right z-10">
                                <p className="text-sm text-slate-500 font-semibold">달성률</p>
                                <p className={`text-3xl font-bold ${targetAmount>0 && (performanceAmount/targetAmount)>=1?'text-emerald-600':'text-indigo-600'}`}>{targetAmount>0?((performanceAmount/targetAmount)*100).toFixed(1):0}%</p>
                            </div>
                        </div>
                        {[{l:'매출 실적',v:performanceAmount,c:'emerald',i:WonIcon},{l:'매출 확정',v:confirmedAmount,c:'blue',i:Briefcase},{l:'매출 예정',v:expectedAmount,c:'amber',i:TrendingUp},{l:'매출 미정',v:undecidedAmount,c:'slate',i:Users}].map((k,i) => (
                            <div key={i} className={`bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-${k.c}-500 border-y border-r border-slate-100 flex flex-col justify-between min-h-[105px] relative overflow-hidden group`}>
                                <div className="z-10"><p className="text-sm font-bold text-slate-500 uppercase">{k.l}</p><p className="text-3xl font-extrabold text-slate-800 mt-2">{formatCurrency(k.v)}</p></div>
                                <div className={`absolute -bottom-4 -right-4 text-${k.c}-50 opacity-50 group-hover:opacity-100 transform rotate-12`}><k.i size={80} className={`text-${k.c}-200 w-20 h-20`}/></div>
                            </div>
                        ))}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 className="text-lg font-semibold mb-6 flex items-center"><Calendar size={20} className="mr-2 text-indigo-500"/> 월별 매출 현황</h3>
                            <div className="h-80 w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={monthlyData} margin={{top:20,right:30,left:40,bottom:5}} barCategoryGap="10%">
                                        <CartesianGrid strokeDasharray="3 3" vertical={false}/>
                                        <XAxis dataKey="name" axisLine={false} tickLine={false} interval={0}/>
                                        <YAxis axisLine={false} tickLine={false} tickFormatter={formatMillions}/>
                                        <Tooltip formatter={formatCurrency}/>
                                        <Bar dataKey="매출" stackId="a" fill={STACK_COLORS['매출']} maxBarSize={100}/>
                                        <Bar dataKey="확정" stackId="a" fill={STACK_COLORS['확정']} maxBarSize={100}/>
                                        <Bar dataKey="예정" stackId="a" fill={STACK_COLORS['예정']} maxBarSize={100}/>
                                        <Bar dataKey="미정" stackId="a" fill={STACK_COLORS['미정']} radius={[4,4,0,0]} maxBarSize={100}/>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 className="text-lg font-semibold mb-6">거래처 등급 분포</h3>
                            <div className="h-80 w-full flex justify-center">
                                {gradeData.length > 0 ? (
                                    <ResponsiveContainer>
                                        <PieChart>
                                            <Pie data={gradeData} cx="50%" cy="50%" innerRadius={50} outerRadius={115} paddingAngle={2} dataKey="value" label={({ cx, cy, midAngle, outerRadius, value }) => {
                                                const RADIAN = Math.PI / 180; const r = outerRadius + 20; const x = cx + r * Math.cos(-midAngle * RADIAN); const y = cy + r * Math.sin(-midAngle * RADIAN);
                                                return <text x={x} y={y} fill="#334155" textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central" fontSize={13} fontWeight={700}>{formatMillions(value)}</text>;
                                            }}><Cell/></Pie>
                                            <Pie data={gradeData} cx="50%" cy="50%" innerRadius={50} outerRadius={115} dataKey="value" label={({ cx, cy, midAngle, innerRadius, outerRadius, percent, name }) => {
                                                const RADIAN = Math.PI / 180; const r = innerRadius + (outerRadius - innerRadius) * 0.5; const x = cx + r * Math.cos(-midAngle * RADIAN); const y = cy + r * Math.sin(-midAngle * RADIAN);
                                                if (percent < 0.04) return null;
                                                return <text x={x} y={y} fill="white" textAnchor="middle" dominantBaseline="central" fontSize={12} fontWeight="bold" style={{textShadow: '0px 0px 3px rgba(0,0,0,0.5)'}}>{`${name} (${(percent * 100).toFixed(1)}%)`}</text>;
                                            }} labelLine={false} fill="none"><Cell/></Pie>
                                        </PieChart>
                                    </ResponsiveContainer>
                                ) : <div className="text-slate-400 mt-20">데이터가 없습니다.</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- CONTACT LIST ---
        const ContactList = ({ contacts, deals, onSelectContact, onAddContact, onUpdateContact, onDeleteContact }) => {
            const [term, setTerm] = useState('');
            const [isOpen, setIsOpen] = useState(false);
            const [modalMode, setModalMode] = useState('add');
            const [form, setForm] = useState({});
            const [includeDeal, setIncludeDeal] = useState(false);
            const [formDeal, setFormDeal] = useState({});
            const [showAddr, setShowAddr] = useState(false);

            const filtered = contacts.filter(c => c.name.includes(term) || c.company.includes(term));
            const openAdd = () => { setModalMode('add'); setForm({department: '영업 1팀', role: '', type: 'Company'}); setIsOpen(true); };
            const openEdit = (e, c) => { 
                e.stopPropagation(); 
                setModalMode('edit'); 
                setForm({...c}); 
                const d = deals.find(x=>x.contactId===c.id);
                if(d) { setIncludeDeal(true); setFormDeal({...d}); } else { setIncludeDeal(false); setFormDeal({}); }
                setIsOpen(true); 
            };
            const submit = (e) => {
                e.preventDefault();
                const id = modalMode==='edit' && form.id ? form.id : `c${Date.now()}`;
                const newContact = { ...form, id, notes: form.notes||[], grade: form.grade||'B', targetAmount: Number(form.targetAmount)||0 };
                let newDeal;
                if(includeDeal) {
                    newDeal = { ...formDeal, id: formDeal.id || `d${Date.now()}`, contactId: id, value: (Number(formDeal.productAmount)||0)+(Number(formDeal.goodsAmount)||0), stage: formDeal.status==='매출'?'계약 성사 (Closed Won)':'제안 단계 (Proposal)' };
                }
                if(modalMode==='edit') onUpdateContact(newContact, newDeal);
                else onAddContact(newContact, newDeal);
                setIsOpen(false);
            };

            return (
                <div className="space-y-6 animate-fade-in relative">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold">거래처 및 매출 관리</h2>
                        <div className="flex gap-2">
                            <input className="pl-2 p-2 border rounded-lg" placeholder="검색..." value={term} onChange={e=>setTerm(e.target.value)}/>
                            <button onClick={openAdd} className="px-4 py-2 bg-indigo-600 text-white rounded-lg flex items-center"><Plus size={20} className="mr-1"/> 등록</button>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 border-b">
                                <tr><th className="px-4 py-4">거래처/유형/지역</th><th className="px-4 py-4">고객 정보</th><th className="px-4 py-4">매출 현황 (제품/상품/계)</th><th className="px-4 py-4">관리</th></tr>
                            </thead>
                            <tbody className="divide-y">
                                {filtered.map(c => {
                                    const d = deals.filter(x=>x.contactId===c.id);
                                    const t = d.reduce((s,x)=>s+x.value,0);
                                    return (
                                        <tr key={c.id} className="hover:bg-slate-50 cursor-pointer" onClick={()=>onSelectContact(c)}>
                                            <td className="px-4 py-4">
                                                <div className="font-medium">{c.company}</div><div className="text-xs bg-slate-100 inline-block px-1 rounded">{c.type}</div>
                                                <div className="text-xs text-slate-400 mt-1"><MapPin size={10} className="inline"/> {c.address}</div>
                                            </td>
                                            <td className="px-4 py-4"><div className="font-medium">{c.name}</div><div className="text-xs text-slate-500">{c.email}</div></td>
                                            <td className="px-4 py-4 text-sm font-medium text-emerald-600">
                                                {new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW'}).format(t)}
                                            </td>
                                            <td className="px-4 py-4 text-right">
                                                <button onClick={(e)=>openEdit(e,c)} className="p-2 text-indigo-600"><Edit size={16}/></button>
                                                <button onClick={(e)=>{e.stopPropagation(); if(confirm('삭제?')) onDeleteContact(c.id)}} className="p-2 text-red-500"><Trash2 size={16}/></button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    {isOpen && (
                         <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white p-6 rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                                <h3 className="text-lg font-bold mb-4">{modalMode==='add'?'등록':'수정'}</h3>
                                <form onSubmit={submit} className="space-y-3">
                                    <input required className="w-full p-2 border rounded" placeholder="이름" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})}/>
                                    <input required className="w-full p-2 border rounded" placeholder="회사" value={form.company||''} onChange={e=>setForm({...form,company:e.target.value})}/>
                                    <input className="w-full p-2 border rounded" placeholder="주소 (검색 버튼 생략)" value={form.address||''} onChange={e=>setForm({...form,address:e.target.value})}/>
                                    <div className="border-t pt-2 mt-2">
                                        <label className="flex items-center gap-2"><input type="checkbox" checked={includeDeal} onChange={e=>setIncludeDeal(e.target.checked)}/> 매출 정보 포함</label>
                                        {includeDeal && (
                                            <div className="mt-2 space-y-2 bg-slate-50 p-2 rounded">
                                                <input className="w-full p-2 border rounded" placeholder="건명" value={formDeal.title||''} onChange={e=>setFormDeal({...formDeal,title:e.target.value})}/>
                                                <input type="number" className="w-full p-2 border rounded" placeholder="제품 금액" value={formDeal.productAmount||0} onChange={e=>setFormDeal({...formDeal,productAmount:e.target.value})}/>
                                            </div>
                                        )}
                                    </div>
                                    <button className="w-full py-2 bg-indigo-600 text-white rounded font-bold">저장</button>
                                    <button type="button" onClick={()=>setIsOpen(false)} className="w-full py-2 text-slate-500">취소</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- CONTACT DETAIL ---
        const ContactDetail = ({ contact, deals, onBack }) => {
            const [gradeRes, setGradeRes] = useState('');
            const analyze = async () => { setGradeRes('분석 중...'); const r = await assessAccountGrade(contact.company, contact.type, 0, contact.notes.join(',')); setGradeRes(r); };
            return (
                <div className="space-y-6 animate-fade-in">
                    <button onClick={onBack} className="flex items-center text-slate-500 hover:text-indigo-600"><ArrowLeft size={20} className="mr-2"/> 목록</button>
                    <div className="bg-white p-8 rounded-xl border shadow-sm">
                        <h1 className="text-2xl font-bold">{contact.name} <span className="text-sm font-normal bg-slate-100 px-2 rounded">{contact.company}</span></h1>
                        <div className="mt-6 grid grid-cols-2 gap-8">
                            <div className="p-4 border rounded-lg bg-slate-50">
                                <h3 className="font-bold text-sm text-slate-500 mb-2">AI 등급 분석</h3>
                                <button onClick={analyze} className="px-3 py-1 bg-white border text-indigo-600 rounded text-sm mb-2"><Search size={14} className="inline mr-1"/> 실행</button>
                                <div className="text-sm whitespace-pre-line text-slate-700">{gradeRes}</div>
                            </div>
                            <div>
                                <h3 className="font-bold">진행 중인 거래</h3>
                                {deals.filter(d=>d.contactId===contact.id).map(d=>(
                                    <div key={d.id} className="p-3 border rounded bg-slate-50 mt-2">
                                        <div className="font-semibold">{d.title}</div>
                                        <div className="text-sm">{d.status} | {new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW'}).format(d.value)}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- SETTINGS ---
        const Settings = ({ salesReps, onAddRep, onUpdateRep, onDeleteRep, onUploadSamples }) => {
            const [newRep, setNewRep] = useState({ name: '', team: '영업 1팀', department: '영업본부', role: 'staff', email: '', phone: '', profilePicture: '' });
            const fileRef = useRef(null);
            const handleFile = (e, isEdit, id) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onloadend = () => {
                        if(isEdit) { const existing = salesReps.find(x=>x.id===id); if(existing) onUpdateRep({...existing, profilePicture: r.result}); }
                        else setNewRep(p=>({...p, profilePicture: r.result}));
                    };
                    r.readAsDataURL(f);
                }
            };
            return (
                <div className="space-y-6 max-w-4xl mx-auto animate-fade-in">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-2xl font-bold flex items-center"><SettingsIcon className="mr-2"/> 설정</h2>
                        <div className="flex gap-2">
                             <button onClick={onUploadSamples} className="flex items-center px-4 py-2 bg-emerald-50 text-emerald-600 rounded-lg"><UploadCloud size={16} className="mr-2"/> 구글 시트 업로드</button>
                             <button onClick={()=>{if(confirm('초기화?'))resetToSampleData().then(()=>window.location.reload())}} className="flex items-center px-4 py-2 bg-red-50 text-red-600 rounded-lg"><RefreshCw size={16} className="mr-2"/> 초기화</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div className="md:col-span-2 bg-white rounded-xl shadow-sm border overflow-hidden">
                            <h3 className="bg-slate-50 px-6 py-4 border-b font-semibold">직원 목록</h3>
                            <ul className="divide-y">
                                {salesReps.map(r => (
                                    <li key={r.id} className="px-6 py-4 flex justify-between items-center group">
                                        <div className="flex items-center gap-4">
                                            <div className="h-12 w-12 rounded-full bg-slate-200 overflow-hidden relative cursor-pointer group/avatar" onClick={()=>document.getElementById(`file-${r.id}`).click()}>
                                                {r.profilePicture?<img src={r.profilePicture} className="w-full h-full object-cover"/>:<span className="flex justify-center items-center h-full font-bold">{r.name[0]}</span>}
                                                <div className="absolute inset-0 bg-black/30 hidden group-hover/avatar:flex items-center justify-center"><Camera size={16} className="text-white"/></div>
                                            </div>
                                            <input type="file" id={`file-${r.id}`} className="hidden" onChange={(e)=>handleFile(e,true,r.id)}/>
                                            <div><p className="font-medium">{r.name} <span className="text-xs bg-slate-100 px-2 rounded">{r.role}</span></p><p className="text-sm text-slate-500">{r.team} | {r.phone}</p></div>
                                        </div>
                                        <button onClick={()=>confirm('삭제?')&&onDeleteRep(r.id)} className="text-slate-300 hover:text-red-500"><Trash2/></button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                        <div className="bg-white rounded-xl shadow-sm border p-6 h-fit">
                            <h3 className="font-semibold mb-4 flex items-center"><Plus size={18} className="mr-2 text-indigo-600"/> 새 직원 등록</h3>
                            <div className="space-y-3">
                                <div className="flex justify-center mb-4 cursor-pointer" onClick={()=>fileRef.current.click()}>
                                    <div className="h-20 w-20 rounded-full border-2 border-dashed bg-slate-50 flex flex-col items-center justify-center overflow-hidden">
                                        {newRep.profilePicture?<img src={newRep.profilePicture} className="w-full h-full object-cover"/>:<Camera className="text-slate-400"/>}
                                    </div>
                                    <input type="file" ref={fileRef} className="hidden" onChange={(e)=>handleFile(e,false)}/>
                                </div>
                                <input className="w-full p-2 border rounded" placeholder="이름" value={newRep.name} onChange={e=>setNewRep({...newRep,name:e.target.value})}/>
                                <input className="w-full p-2 border rounded" placeholder="이메일" value={newRep.email} onChange={e=>setNewRep({...newRep,email:e.target.value})}/>
                                <input className="w-full p-2 border rounded" placeholder="전화번호" value={newRep.phone} onChange={e=>setNewRep({...newRep,phone:e.target.value})}/>
                                <select className="w-full p-2 border rounded" value={newRep.team} onChange={e=>setNewRep({...newRep,team:e.target.value})}>
                                    <option>영업 1팀</option><option>영업 2팀</option>
                                </select>
                                <button onClick={()=>{onAddRep({...newRep, id:`s${Date.now()}`}); setNewRep({name:'',team:'영업 1팀',department:'영업본부',role:'staff',email:'',phone:'',profilePicture:''})}} className="w-full py-2 bg-indigo-600 text-white rounded font-medium">추가</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('dashboard');
            const [contacts, setContacts] = useState([]);
            const [deals, setDeals] = useState([]);
            const [reps, setReps] = useState([]);
            const [selContact, setSelContact] = useState(null);
            const [loading, setLoading] = useState(true);
            const [user, setUser] = useState(MOCK_SALES_REPS[0]);
            const [sidebarOpen, setSidebarOpen] = useState(false);

            useEffect(() => {
                loadInitialData().then(d => {
                    setContacts(d.contacts); setDeals(d.deals); setReps(d.salesReps);
                    if(d.salesReps.length) setUser(d.salesReps[0]);
                    setLoading(false);
                });
            }, []);

            const save = () => saveDataToSheet(contacts, deals, reps).then(()=>alert('저장 완료'));
            const upload = () => saveDataToSheet(contacts, deals, reps).then(()=>alert('업로드 완료'));
            const sync = () => loadInitialData().then(d=>{ setContacts(d.contacts); setDeals(d.deals); setReps(d.salesReps); alert('동기화 완료'); });

            if(loading) return <div className="h-screen flex items-center justify-center text-indigo-600 font-bold">Loading IEG CRM...</div>;

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden">
                    <aside className={`fixed lg:static inset-y-0 left-0 z-50 w-72 bg-white border-r flex flex-col no-print transition-transform duration-300 ${sidebarOpen?'translate-x-0':'-translate-x-full lg:translate-x-0'}`}>
                        <div className="p-6 flex items-center justify-between border-b">
                            <div className="flex items-center gap-2"><Activity className="text-indigo-600"/><span className="text-2xl font-bold"><span className="text-blue-600">IEG</span> CRM</span></div>
                            <button onClick={()=>setSidebarOpen(false)} className="lg:hidden"><X/></button>
                        </div>
                        <nav className="flex-1 px-4 mt-6 space-y-2">
                            {[{id:'dashboard',l:'대시보드',i:LayoutDashboard},{id:'contacts',l:'거래처 관리',i:Users},{id:'pipeline',l:'파이프라인',i:Kanban},{id:'settings',l:'설정',i:SettingsIcon}].map(m=>(
                                <button key={m.id} onClick={()=>{setView(m.id);setSelContact(null);setSidebarOpen(false)}} className={`w-full flex items-center px-4 py-3 rounded-xl font-medium ${view===m.id&&!selContact?'bg-indigo-600 text-white':'text-slate-500 hover:bg-slate-100'}`}><m.i className="mr-3" size={20}/>{m.l}</button>
                            ))}
                        </nav>
                        <div className="p-4 grid grid-cols-2 gap-2">
                            <button onClick={sync} className="py-2 border rounded flex justify-center items-center hover:bg-slate-50"><FileSpreadsheet size={16} className="mr-1"/>불러오기</button>
                            <button onClick={save} className="py-2 bg-indigo-50 text-indigo-700 border border-indigo-100 rounded flex justify-center items-center"><Save size={16} className="mr-1"/>저장</button>
                        </div>
                    </aside>
                    <main className="flex-1 overflow-auto p-4 lg:p-8 relative">
                        <header className="lg:hidden flex justify-between items-center mb-4 no-print">
                            <span className="font-bold text-lg"><span className="text-blue-600">IEG</span> CRM</span>
                            <button onClick={()=>setSidebarOpen(true)}><Menu/></button>
                        </header>
                        {selContact ? <ContactDetail contact={selContact} deals={deals} onBack={()=>setSelContact(null)}/> : (
                         view === 'dashboard' ? <Dashboard deals={deals} contacts={contacts} currentUser={user} salesReps={reps} onExportToSheet={save}/> :
                         view === 'contacts' ? <ContactList contacts={contacts} deals={deals} onSelectContact={setSelContact} onAddContact={(c,d)=>{setContacts([...contacts,c]); if(d) setDeals([...deals,d])}} onUpdateContact={(c,d)=>{setContacts(contacts.map(x=>x.id===c.id?c:x)); if(d) setDeals([...deals,d])}} onDeleteContact={id=>{setContacts(contacts.filter(c=>c.id!==id))}}/> :
                         view === 'settings' ? <Settings salesReps={reps} onAddRep={r=>setReps([...reps,r])} onDeleteRep={id=>setReps(reps.filter(r=>r.id!==id))} onUpdateRep={r=>setReps(reps.map(x=>x.id===r.id?r:x))} onUploadSamples={upload}/> :
                         <div className="p-4">파이프라인 화면</div> 
                        )}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
